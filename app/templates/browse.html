{% extends "layout.html" %}
{% set title = "Arquivos" %}

{% block content %}
<section class="panel">
  <h1>Arquivos</h1>
  <div class="path">Base: {{ base_path }}{% if rel_path %} / {{ rel_path }}{% endif %}</div>
  <div class="actions">
    {% if parent is not none %}
      <a class="btn" href="{{ url_for('browse', path=parent) }}">⬅ Voltar</a>
    {% endif %}
  </div>

  <form action="{{ url_for('download_multi') }}" method="post" id="download-form">
    <input type="hidden" name="path" value="{{ rel_path }}" />
    <div class="actions">
      <button class="btn" type="submit">Download selecionados</button>
    </div>
    <table class="table">
    <thead>
      <tr>
        <th>Selecionar</th>
        <th>Nome</th>
        <th>Tipo</th>
        <th>Tamanho</th>
        <th>Modificado</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody>
      {% for e in entries %}
      <tr>
        <td>
          {% if not e.is_dir %}
            <input type="checkbox" name="files" value="{{ e.name }}" />
          {% endif %}
        </td>
        <td>
          {% if e.is_dir %}
            <a href="{{ url_for('browse', path=(rel_path + '/' if rel_path else '') + e.name) }}">{{ e.name }}</a>
          {% else %}
            {{ e.name }}
          {% endif %}
        </td>
        <td>{{ 'Pasta' if e.is_dir else 'Arquivo' }}</td>
        <td>{{ e.size }}</td>
        <td>{{ e.mtime.strftime('%Y-%m-%d %H:%M') }}</td>
        <td>
          {% if not e.is_dir %}
            <a class="btn" href="{{ url_for('download', path=(rel_path + '/' if rel_path else '') + e.name) }}">Download</a>
            {% if e.name.lower().endswith('.csv') %}
              <a class="btn" href="{{ url_for('csv_edit', path=(rel_path + '/' if rel_path else '') + e.name) }}">Editar</a>
            {% endif %}
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
    </table>
  </form>

  <form class="upload" action="{{ url_for('upload') }}" method="post" enctype="multipart/form-data" id="upload-form">
    <input type="hidden" name="path" value="{{ rel_path }}" />
    <label>Upload de arquivos</label>
    <div class="upload-row">
      <input type="file" name="files" id="upload-file" multiple required />
      <button class="btn" type="submit">Enviar</button>
    </div>
  </form>
</section>

<script>
  const uploadForm = document.getElementById("upload-form");
  const uploadFile = document.getElementById("upload-file");
  const downloadForm = document.getElementById("download-form");
  let lastCheck = { name: "", exists: false };

  async function checkExists() {
    const files = Array.from(uploadFile.files || []);
    if (!files.length) return null;
    if (files.length === 1 && lastCheck.name === files[0].name) return lastCheck.exists;

    const results = await Promise.all(
      files.map(async (file) => {
        const params = new URLSearchParams({
          path: "{{ rel_path }}",
          name: file.name,
        });
        const res = await fetch(`/api/exists?${params.toString()}`);
        if (!res.ok) return false;
        const data = await res.json();
        return Boolean(data.exists);
      })
    );

    if (files.length === 1) {
      lastCheck = { name: files[0].name, exists: results[0] };
    }

    return results.some(Boolean);
  }

  uploadForm.addEventListener("submit", async (e) => {
    const exists = await checkExists();
    if (exists) {
      const ok = window.confirm("Arquivo já existe. Deseja substituir?");
      if (!ok) {
        e.preventDefault();
      }
    }
  });

  downloadForm.addEventListener("submit", (e) => {
    const checked = downloadForm.querySelectorAll('input[name="files"]:checked');
    if (!checked.length) {
      e.preventDefault();
      window.alert("Selecione ao menos um arquivo para download.");
    }
  });
</script>
{% endblock %}
